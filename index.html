<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Chat PeerJS</title>
  </head>
  <body>
    <h2>My ID :</h2>
    <p id="my-id"></p>

    <h3>Connect to an ID :</h3>
    <input type="text" id="other-id" placeholder="Other's ID" />
    <button id="connect-btn">Connect</button>

    <h3>Chat</h3>
    <div
      id="messages"
      style="
        border: 1px solid #000;
        height: 150px;
        overflow: auto;
        padding: 5px;
      "
    ></div>

    <input type="text" id="pseudo" placeholder="Pseudo *" required/>

    <input type="text" id="msg" placeholder="Message *" required/>
    <button id="send-btn">Send</button>
    <button id="send-img-btn">ðŸ“· Image</button>
    <input type="file" id="img-input" accept="image/*" style="display:none">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
      let conn = null;

      const peer = new Peer();

      peer.on("open", (id) => {
        document.getElementById("my-id").textContent = id;
      });

      peer.on("connection", (c) => {
        conn = c;
        setupConnection();
      });

      document.getElementById("connect-btn").onclick = () => {
        const otherId = document.getElementById("other-id").value;
        conn = peer.connect(otherId);
        setupConnection();
      };

      function setupConnection() {
        conn.on("open", () => {
          addMessage("Connected !");
        });

        conn.on("data", (data) => {
          if (data.type === "image") {
            addImage(data.pseudo, data.message, data.data);
          } else {
            addMessage(data.pseudo + " : " + data.message);
          }
        });
      }

      document.getElementById("send-btn").onclick = () => {
        const pseudo = document.getElementById("pseudo").value;
        const msg = document.getElementById("msg").value;

        if (conn && msg.trim() !== "" && pseudo.trim() !== "") {
          conn.send({
            type: "text",
            pseudo: pseudo,
            message: msg
          });
          addMessage(pseudo + " : " + msg);
          document.getElementById("msg").value = "";
        } else {
          alert("Veuillez saisir un pseudo et un message");
        }
      };

      const imgInput = document.getElementById("img-input");
      document.getElementById("send-img-btn").onclick = () => {
        const pseudo = document.getElementById("pseudo").value;
        if (pseudo.trim() === "") {
          alert("Veuillez saisir un pseudo avant d'envoyer une image");
          return;
        }
        imgInput.click();
      };

      imgInput.onchange = () => {
        const file = imgInput.files[0];
        if (!file || !conn) return;

        const pseudo = document.getElementById("pseudo").value;
        const message = document.getElementById("msg").value;

        if (pseudo.trim() === "") {
          alert("Veuillez saisir un pseudo avant d'envoyer une image");
          imgInput.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          conn.send({
            type: "image",
            pseudo: pseudo,
            message: message,
            data: reader.result
          });

          addImage(pseudo, message, reader.result);
          
          imgInput.value = "";
          document.getElementById("msg").value = "";
        };
        reader.readAsDataURL(file);
      };

      function addMessage(text) {
        const div = document.getElementById("messages");
        div.innerHTML += text + "<br>";
        div.scrollTop = div.scrollHeight;
      }

      function addImage(pseudo, message, base64) {
        const div = document.getElementById("messages");
        const messageContainer = document.createElement("div");
        messageContainer.style.marginBottom = "10px";
        if (message && message.trim() !== "") {
          messageContainer.innerHTML = "<b>" + pseudo + " : " + message + "</b><br>";
        } else {
          messageContainer.innerHTML = "<b>" + pseudo + " :</b><br>";
        }
        const img = document.createElement("img");
        img.src = base64;
        img.style.maxWidth = "100%";
        img.style.maxHeight = "120px";
        img.style.marginTop = "5px";
        img.style.border = "1px solid #ccc";
        img.style.borderRadius = "5px";

        messageContainer.appendChild(img);
        div.appendChild(messageContainer);

        div.scrollTop = div.scrollHeight;
      }
    </script>
  </body>
</html>